## üöÄ  New features

### Built-in alleles database

MiXCR features robust support for inferring donor-specific allelic variants of V and J genes from NGS data, using the [`findAlleles`](https://mixcr.com/mixcr/reference/mixcr-findAlleles/) command. With this new release, we introduce a comprehensive built-in database of human alleles. Now, the [`findAlleles`](https://mixcr.com/mixcr/reference/mixcr-findAlleles/)  command will utilize known allele names from this integrated library. Feel free to explore our database at https://vdj.online/library.

<img width="1580" alt="image" src="https://github.com/milaboratory/mixcr/assets/3834261/a6e6841a-6018-4eeb-9599-1b9761f6346c">

### New rigorous quality checks

MiXCR now offers detailed insights into the quality of input data with its new quality control (QC) checks. A comprehensive [list of checks](https://mixcr.com/mixcr/reference/qc-list-of-checks/) provides complete information about the data and facilitates immediate feedback to the wet lab if any issues are detected

<img width="913" alt="image" src="https://github.com/milaboratory/mixcr/assets/3834261/a1e602a1-3c34-4ecc-bd8f-18947ca6dbf7">

### Convenient way to build custom libraries

Now one can build gene segment reference library for de-novo libraries or for chimeric model animals with just a single [`buildLibrary`](https://mixcr.com/mixcr/reference/mixcr-buildLibrary/) command. Check out our [updated guide](https://mixcr.com/mixcr/guides/create-custom-library/).


```bash
mixcr buildLibrary \
    --v-genes-from-fasta v-genes.IGH.fasta \
    --v-gene-feature VRegion \
    --j-genes-from-fasta j-genes.IGH.fasta \
    --d-genes-from-fasta d-genes.IGH.fasta \ # optional
    --c-genes-from-fasta c-genes.IGH.fasta \ # optional
    --chain IGH \
    --species phocoena \
    phocoena-IGH.json.gz
```

### Comprehensive support of sample sheets

Now one can pass sample sheet directly to MiXCR [`analyze`](https://mixcr.com/mixcr/guides/mixcr-analyze/) command as input. This way one can easily run MiXCR for arbitrary structure of input files, demultiplexed or not, with any type of multiplexing used:

```bash
mixcr analyze generic-sc-ht-vdj-amplicon --species hsa \
    sample-sheet.csv \
    output_prefix
```



### ü§©  New presets

- Support of [MiLaboratories Human 7 Genes DNA Multiplex](https://milaboratories.com/7genes-dna-multiplex-kit): `milab-human-dna-xcr-7genes-multiplex`

- Support of [Parse Bio Evercode TCR presets](https://mixcr.com/mixcr/reference/overview-built-in-presets/#parse-biosciences): `parsebio-tcr-evercode-mini`, `parsebio-tcr-evercode` and `parsebio-tcr-evercode-mega`

- Support of [FLAIRR-Seq](https://pubmed.ncbi.nlm.nih.gov/37027017/) protocol via `flairr-seq` preset

- New generic single cell presets:

  - Low throughput (e.g. micro-wells) amplicon-based single cell:
    - No UMIs: `generic-sc-lt-vdj-amplicon`
    - With UMIs: `generic-sc-lt-vdj-amplicon-umi`

  - Low throughput (e.g. micro-wells) single cell with fragmentation (RNA-Seq):
    - No UMIs: `generic-sc-lt-vdj-fragmented`
    - With UMIs: `generic-sc-lt-vdj-fragmented-umi`

  - High throughput (e.g. droplets) amplicon-based single cell:
    - No UMIs: `generic-sc-ht-vdj-amplicon`
    - With UMIs: `generic-sc-ht-vdj-amplicon-umi`

  - High throughput (e.g. droplets) single cell with fragmentation (RNA-Seq):
    - No UMIs: `generic-sc-ht-vdj-fragmented`
    - With UMIs: `generic-sc-ht-vdj-fragmented-umi`
    
  - Reconstructing VDJ from generic gene expression data:
    - No UMIs: `generic-sc-gex`
    - With UMIs: `generic-sc-gex-umi`  
    
- New [Biomed2](http://127.0.0.1:8000/mixcr/reference/overview-built-in-presets/#biomed2) primer sets: `biomed2-human-rna-igkl`, `biomed2-human-rna-trbdg`.
    

### üí™  Major changes

- Improved aligner parameters for all protocols. We spent in total more than 1,000,000 CPU/hours running optimization. As a result alignment rate is better for most of the protocols, especially in the case of average data quality.

- Special mechanism to allow for `NaN` values in metrics in group filters (used in `minSequenceCount` parameter in k-mer filter, see below).

- Adds new `minSequenceCount` parameter for k-mer filter, allowing construction of more flexible filtering pipelines with better fallback behaviour for under-sequenced libraries.

- Now full sample sheet with input file names can be provided as an input to the pipeline.

- Sample sheets provided both with `--sample-table` mixin and as a pipeline input, will be fuzzy matched against the data, allowing for one substitutions in unambiguous cases. This behaviour can be turned off by using `--sample-table-strict` mixin instead, or by adding a `--strict-sample-sheet-matching` option if full sample sheet input is used as pipeline input.

- New commands: [`mixcr qc`](https://mixcr.com/mixcr/guides/mixcr-qc/), [`mixcr buildLibrary`](https://mixcr.com/mixcr/guides/mixcr-buildLibrary/)) , [`mixcr mergeLibrary`](https://mixcr.com/mixcr/guides/mixcr-mergeLibrary/), [`mixcr debugLibrary`](https://mixcr.com/mixcr/guides/mixcr-debugLibrary/))

- Various major improvements to sequencing and PCR error correction algorithms for tags and clonotypes:
  - tag refinement now uses average quality in statistical inference; this is the correct approach from the mathematical point of view, and it slightly increases performance judging by better consensus assembly downstream
  - statistical inference in PCR error correction redone from scratch, now it takes into account aggregated quality scores of clonotypes, which makes the procedure automatically adapt to low quality samples and better perform in many marginal cases in both UMI and non-UMI protocols 
  - better algorithm for quality score aggregation in clonotype assembly
  - better algorithm for quality score aggregation in consensus assembly

- Mechanism to apply different tag transformations on the `align` step. Transformations include mappings, string and sequence manipulations and various arithmetic operations. This feature allows to fit single-cell scenarios where multiple well-known barcodes marks the same cell, allows to convert sequence barcodes to textual representation to adopt different barcode naming schemas used in some protocols, convert multiple barcodes to single cell id. Feature is currently used in presets for analysis of data from Parse Bioscience and BD Rhapsody single-cell platforms.

- Added fallback behaviour for under-sequenced libraries for 10x VDJ presets


### üêû  Bug fixes 

- Fix for naming of intermediate files and reports produced by `analyze` if target folder is specified
- Tag pattern now is also searched in reverse strand for single-ended input with `--tag-parse-unstranded`


### üë∑  Minor fixes and improvements

- Added gene feature coverage in alignment report

- On Linux platforms default calculation of -Xmx now based on "available" memory (previously "free" was used)

- New gene aligner parameter `edgeRealignmentMinScoreOverride` for more sensitive alignments for short paired-end reads

- Report values downstream `align` now calculate percents relative to the number of reads in the sample rather than the
  total number of reads in multi-sample analysis
- options helping with advanced analysis of data quality and consensus assembly process added
  to `assemble` (`--consensus-alignments`, `--consensus-state-stat`, `--downsample-consensus-state-stat`)
  and `analyze` (`--output-consensus-alignments`, `--output-consensus-state-stat`, `--downsample-consensus-state-stat`)
- fixed bug not allowing to parse more than two reads with tag pattern
- better tag pattern search projection representation in reports
- fix for value in report line `Reads dropped due to low quality, percent of total report string`
- additional report string "Aligned reads processed" in `assemble` report
- fix bug when `--chains` is used with `exportClonesOverlap`
- fix for `export...` - tag quality field added back to export columns
- fixes bug not allowing to use more than 2 input reads in pattern matching
- added options `--by-feature` and `--by-gene` to `sortClones`
- added options `-rankByReads` and `-rankByTag <(Molecule|Cell|Sample)>` to `exportClones`
  and `exportShmTreesWithNodes.txt`
- export readIds in `exportAlignments` by default
- `findAlleles` now recalculate functionality of de novo found alleles
- add info about CDR3 in generated hash for de novo alleles
- more robust algorithm for calculating checksum of library
- remove de novo alleles that are actually the same, will be left only one
- `findAlleles` will remove not used genes from library (genes that not represented in given donor)
- make `--chains` optional in `downsampling` command and allow multiple input
- write empty file on `exportClones` if file doesn't contain any clones
- better exception messages on incorrect inputs for export commands
- on `exportClones` write `no_d_gene` if requested VDJunction, DCDR3Part or DJJunction in absence of D hit

- Additional report string "Aligned reads processed" in `assemble` report

- Fixed bug when `--chains` is used with `exportClonesOverlap`

- Fixed for `export...` - tag quality field added back to export columns

- Fixed bug not allowing to use more than 2 input reads in pattern matching

- Added options `--by-feature` and `--by-gene` to `sortClones`

- Added options `-rankByReads` and `-rankByTag <(Molecule|Cell|Sample)>` to `exportClones` and `exportShmTreesWithNodes.txt`

- Export readIds in `exportAlignments` by default

- Added recalculation functionality for de-novo found alleles in `findAlleles`

- Add info about CDR3 in generated hash for de-novo alleles

- More robust algorithm for calculating checksum of reference library

- Remove de-novo alleles that are actually the same

- `findAlleles` will remove not used genes from the library (genes that not represented in given donor)

- Make `--chains` optional in `downsampling` command and allow multiple input

- Write empty file on `exportClones` if file doesn't contain any clones

- Better exception messages on incorrect inputs for export commands

- In `exportClones` write `no_d_gene` if requested `VDJunction`, `DCDR3Part` or `DJJunction` in absence of D hit

- Columns in `exportReportsTable` now covers most of significant statistics from reports



### üê¨  Docker image changes


- Custom entry-point of the image removed, and now is set to `/bin/bash`. Now one needs to specify `mixcr` command at the beginning of argument list:
    
    Old: `docker run ghcr.io/milaboratory/mixcr/mixcr analyze ...`
    
    New: `docker run ghcr.io/milaboratory/mixcr/mixcr mixcr analyze ...`

- New image is based on Amazon Corretto which in turn is based on Amazon Linux 2. If customization is required for the image, one now need to use `yum` package manager instead of `apt`/`apt-get`. 

  With old image:

  ```
  FROM ghcr.io/milaboratory/mixcr/mixcr:4.3.2
  ...
  RUN apt-get install -y wget
  ...
  ```

  With new image:

  ```
  FROM ghcr.io/milaboratory/mixcr/mixcr:4.4.0
  ...
  RUN yum install -y wget
  ...
  ```
  
  [see official docs](https://aws.amazon.com/amazon-linux-2/resources/) for more detais.


- Better compatibility of official docker image with Nextflow


### ‚ÄºÔ∏è  Breaking changes 

- Parameter `clusteringFilter.specificMutationProbability` removed from `assemble` action. Three new parameters are introduced instead:

  - `clusteringFilter.correctionPower` - this parameter determines how thorough the procedure should eliminate erroneous variants. Smaller value leaves less erroneous variants at the cost of accidentally correcting true variants. This value approximates the fraction of erroneous variants the algorithm will miss (type II errors).

  - `clusteringFilter.backgroundSubstitutionRate` - expected rate of substitutions happening before the sequencing.

  - `clusteringFilter.backgroundIndelRate` - expected rate of indels happening before the sequencing.


### ‚ö†Ô∏è  Preset changes


- kAligner2 has been modified to work with both TCR and BCR data, the presets previously divided by the type of data now merged into one. Also, the division by `cdr3` and `full-length` presets has been deprecated; now the presets by default use the longest possible assembling feature according to the protocol:


- `qiaseq-human-tcr-cdr3` and `qiaseq-human-tcr-full-length` are deprecated and replaced by  `qiagen-human-rna-tcr-umi-qiaseq`. `qiagen-human-rna-tcr-umi-qiaseq` assemble clones by `{CDR2Begin:FR4End}` according to the manufactures read length recommendations.

- `qiaseq-mouse-tcr-cdr3` and `qiaseq-mouse-tcr-full-length` are deprecated and replaced by  `qiagen-mouse-rna-tcr-umi-qiaseq`. `qiagen-mouse-rna-tcr-umi-qiaseq` assemble clones by `{CDR2Begin:FR4End}` according to the manufactures read length recommendations.

- Parse bio preset `parse-bio-vdj-3gex` has been deprecated and raced by three presets according to the manufactures' kit options: `parsebio-sc-3gex-evercode-wt`, `parsebio-sc-3gex-evercode-wt-mini`, `parsebio-sc-3gex-evercode-wt-mega`. Now the presets include the whitelists for all CELL barcodes. CELL1, CELL2 and CELL3 now correspond to ParseBio Round 1, Round 2 and Round 3 (the order is reversed compared to the deprecated preset). Original Parse Bio cell barcodes naming has been added.

- Generic amplicon presets `generic-tcr-amplicon`, `generic-bcr-amplicon`, `generic-tcr-amplicon-umi` and `generic-bcr-amplicon-umi` are deprecated. New generic amplicon presets: `generic-amplicon` and `generic-amplicon-with-umi`

- `abhelix-human-bcr-cdr3`, `abhelix-human-bcr-full-length`, `abhelix-human-tcr-cdr3`, `abhelix-human-tcr-full-length` are all deprecated and replaced by `abhelix-human-rna-xcr` with the default assembling feature `{FR1Begin:FR4End}` according to the manufactures' protocol.

- `takara-human-bcr-cdr3` and `takara-human-bcr-full-length` are deprecated and replaced by `takara-human-rna-bcr-umi-smartseq` with assembling feature `{VDJRegion}`

- `takara-human-tcr-V2-cdr3` and `takara-human-tcr-V2-full-length` are deprecated and replaced by `takara-human-rna-tcr-umi-smarter-v2` with assembling feature `{VDJRegion}`

- `takara-human-tcr-V1-cdr3` and `takara-human-tcr-V1-full-length` are deprecated and replaced by `takara-human-rna-tcr-smarter` with assembling feature `{VDJRegion}`

- `takara-mouse-bcr-full-length` and `takara-mouse-tcr-cdr3` are deprecated and replaced by `takara-mouse-rna-bcr-smarter` with assembling feature `{VDJRegion}`

- `takara-mouse-tcr-cdr3` and `takara-mouse-tcr-full-length` are deprecated and replaced by `takara-mouse-rna-tcr-smarter` with assembling feature `{VDJRegion}`

- `biomed2-human-bcr-cdr3` and `biomed2-human-bcr-full-length` are deprecated and replaced by `biomed2-human-rna-igh` with assembling feature `{CDR1Begin:CDR3End}`

- `ampliseq-tcrb-sr-cdr3` has been deprecated and replaced with `illumina-human-rna-trb-ampliseq-sr`

- `ampliseq-tcrb-plus-full-length` and `ampliseq-tcrb-plus-cdr3` are deprecated and replaced by `illumina-human-rna-trb-ampliseq-plus` with assembling feature `{CDR1Begin:FR4End}`

- `irepertoire-human-rna-tcr-sr` and `irepertoire-human-rna-bcr-sr` are deprecated and replaced by `irepertoire-human-rna-xcr-repseq-sr`

- `irepertoire-human-rna-tcr-lr` and `irepertoire-human-rna-bcr-lr` are deprecated and replaced by `irepertoire-human-rna-xcr-repseq-lr`

- `irepertoire-mouse-rna-tcr-sr` and `irepertoire-mouse-rna-bcr-sr` are deprecated and replaced by `irepertoire-mouse-rna-xcr-repseq-sr`

- `irepertoire-mouse-rna-tcr-lr` and `irepertoire-mouse-rna-bcr-lr` are deprecated and replaced by `irepertoire-mouse-rna-xcr-repseq-lr`

- `irepertoire-human-dna-trb-sr` and `irepertoire-human-dna-igh-sr` are deprecated and replaced by `irepertoire-human-dna-xcr-repseq-sr`

- `irepertoire-human-dna-trb-lr` and `irepertoire-human-dna-igh-lr` are deprecated and replaced by `irepertoire-human-dna-xcr-repseq-lr`

- `milab-human-bcr-multiplex-cdr3` and `milab-human-bcr-multiplex-full-length` are deprecated and replaced by `milab-human-rna-ig-umi-multiplex` with assembling feature `{CDR1Begin:FR4End}`

- `milab-human-tcr-rna-race-full-length` and `milab-human-tcr-rna-race-cdr3` are deprecated and replaced by `milab-human-rna-tcr-umi-race` with assembling feature `{VDJRegion}`

- `milab-human-tcr-rna-multiplex-cdr3` is deprecated and replaced by `milab-human-rna-tcr-umi-multiplex`

- `milab-human-tcr-dna-multiplex-cdr3` is deprecated and replaced by `milab-human-dna-tcr-multiplex`

- `milab-mouse-tcr-rna-race-cdr3` and `milab-mouse-tcr-rna-race-full-length` are deprecated and replaced by `milab-mouse-rna-tcr-umi-race` with assembling feature `{VDJRegion}`

- `nebnext-human-bcr-cdr3`, `nebnext-human-bcr-full-length`, `nebnext-human-tcr-cdr3`, `nebnext-human-tcr-full-length`, `nebnext-human-tcr-bcr-full-length` and `nebnext-human-tcr-bcr-cdr3` are all deprecated and replaced by `neb-human-rna-xcr-umi-nebnext` with assembling feature `{VDJRegion}`

- `nebnext-mouse-bcr-cdr3`, `nebnext-mouse-bcr-full-length`, `nebnext-mouse-tcr-cdr3`, `nebnext-mouse-tcr-full-length`, `nebnext-mouse-tcr-bcr-full-length` and `nebnext-mouse-tcr-bcr-cdr3` are all deprecated and replaced by `neb-mouse-rna-xcr-umi-nebnext` with assembling feature `{VDJRegion}`

- `oncomine-human-tcrb-lr-cdr3` and `oncomine-human-tcrb-lr-full-length` are deprecated and replaced by `thermofisher-human-rna-trb-oncomine-lr` with assembling feature `{CDR1Begin:FR4End}`.

- `oncomine-human-tcrb-sr-cdr3` is deprecated and replaced by `thermofisher-human-rna-trb-oncomine-sr`.

- `oncomine-human-bcr-ihg-lr-cdr3` and `oncomine-human-bcr-ihg-lr-full-length` are deprecated and replaced by `thermofisher-human-rna-igh-oncomine-lr` with assembling feature `{CDR1Begin:FR4End}`.

- `oncomine-human-bcr-pan-clonality-cdr3` and `oncomine-human-tcr-pan-clonality-cdr3` are deprecated and replaced by `thermofisher-human-dna-bcr-oncomine-pan-clonality` and `thermofisher-human-dna-tcr-oncomine-pan-clonality`respectively.

- `oncomine-human-igh-fr3-j` is deprecated and replaced by `thermofisher-human-dna-igh-oncomine-fr3-j`.

- `oncomine-human-igh-fr2-j` is deprecated and replaced by `thermofisher-human-dna-igh-oncomine-fr2-j`.

- `oncomine-human-igh-fr1-j` is deprecated and replaced by `thermofisher-human-dna-igh-oncomine-fr1-j`.

- `oncomine-human-igh-leader-j` is deprecated and replaced by `thermofisher-human-dna-igh-oncomine-v-leader-j`.

- `10x-vdj-tcr`, `10x-vdj-tcr-full-length`, `10x-vdj-bcr` and `10x-vdj-bcr-full-length` are deprecated and replaced by `10x-sc-xcr-vdj`. By default, this preset assembles the longest possible contig for every clone, to replicate the `full-length` behavior one can use `--assemble-contigs-by VDJRegion` parameter to filter out the clones that do not cover the full VDJ region.

- `10x-5gex-cdr3` and `10x-5gex-full-length` are deprecated and replaced by `10x-sc-5gex`. By default, this preset assembles the longest possible contig for every clone, to replicate the `full-length` behavior one can use `--assemble-contigs-by VDJRegion` parameter to filter out the clones that do not cover the full VDJ region.

- `smartseq2-vdj-full-length` is deprecated and replaced by `smart-seq2-vdj`.

- `singleron-2.0.1-vdj-cdr3` is deprecated and replaced by `singleron-human-sc-xcr-gexscope-vdj`.

- `seqwell-vdj-cdr3` is deprecated and replaced by `seq-well-vdj`.

- `parse-bio-vdj-3gex` is deprecated. Three presets introduced according to vendor protocols: `parsebio-sc-3gex-evercode-wt`, `parsebio-sc-3gex-evercode-wt-mini`, `parsebio-sc-3gex-evercode-wt-mega`. 

- `split-seq-vdj-3gex` is deprecated and replaced by `split-seq-3gex`.

- `ont-rna-seq-vdj-full-length` is deprecated and replaced by `ont-rna-seq`.

- New preset for FLAIRR-seq `flairr-seq-bcr`


